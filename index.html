<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Projeto São Mateus – Cronograma (Gantt)</title>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --text:#e6edf7; --muted:#a9b6cc; --line:rgba(255,255,255,.12);
      --good:#18c37e; --warn:#ffbf3c; --bad:#ff5d5d; --info:#5aa7ff;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    body{ margin:0; font-family:var(--font); background:linear-gradient(180deg,#070c16 0%,#0b1220 40%,#070c16 100%); color:var(--text); }
    .wrap{ padding:18px; max-width:1400px; margin:0 auto; }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:14px; }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h1{ margin:0; font-size:18px; letter-spacing:.2px; font-weight:700; }
    .title small{ color:var(--muted); font-size:12px; }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn,.select,.input{
      background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--text);
      padding:9px 10px; border-radius:10px; font-size:13px; outline:none;
    }
    .btn{ cursor:pointer; transition:transform .05s ease, background .15s ease; user-select:none; }
    .btn:hover{ background:rgba(255,255,255,.09); }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:rgba(90,167,255,.18); border-color:rgba(90,167,255,.35); }
    .btn.primary:hover{ background:rgba(90,167,255,.25); }

    .pill{ display:inline-flex; gap:8px; align-items:center; background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:999px; padding:8px 10px; font-size:12px; color:var(--muted); white-space:nowrap; }
    .dot{ width:8px;height:8px;border-radius:50%; background:var(--info); }

    .banner{ margin-top:10px; background:rgba(255,191,60,.12); border:1px solid rgba(255,191,60,.25); color:rgba(255,255,255,.92); padding:10px 12px; border-radius:12px; font-size:12.5px; display:none; line-height:1.35; }
    .banner strong{ color:#ffd27a; }

    .panel{ background:linear-gradient(180deg, rgba(15,27,49,.92), rgba(12,22,42,.92)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
    .grid{ display:grid; grid-template-columns:560px 1fr; min-height:560px; }
    .left{ border-right:1px solid var(--line); background:rgba(0,0,0,.08); overflow:auto; }
    .right{ overflow:auto; position:relative; }

    table{ width:100%; border-collapse:collapse; }
    thead th{ position:sticky; top:0; z-index:3; background:rgba(10,18,32,.95); border-bottom:1px solid var(--line); font-weight:600; font-size:12px; color:var(--muted); text-align:left; padding:10px 10px; white-space:nowrap; }
    tbody td{ border-bottom:1px solid rgba(255,255,255,.06); font-size:12.5px; padding:9px 10px; vertical-align:middle; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px; }
    tbody tr:hover td{ background:rgba(90,167,255,.08); }

    .edt{ font-variant-numeric:tabular-nums; color:var(--muted); width:86px; }
    .activity{ max-width:300px; }
    .status{ width:120px; font-weight:600; }
    .status .badge{ display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); }
    .badge .bDot{ width:8px;height:8px;border-radius:50%; }
    .badge.good .bDot{ background:var(--good); }
    .badge.warn .bDot{ background:var(--warn); }
    .badge.bad  .bDot{ background:var(--bad); }
    .pct{ width:90px; font-variant-numeric:tabular-nums; }
    .date{ width:95px; font-variant-numeric:tabular-nums; color:var(--muted); }
    .res{ max-width:180px; color:var(--muted); }

    /* Tree (EDT) */
    .treeCell{ display:flex; align-items:center; gap:6px; min-width:0; }
    .indent{ display:inline-block; width:0; flex:0 0 auto; }
    .toggle{
      width:16px; height:16px; display:inline-flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06);
      border-radius:6px; cursor:pointer; user-select:none; flex:0 0 auto;
    }
    .toggle:hover{ background:rgba(255,255,255,.10); }
    .toggle[aria-disabled="true"]{ opacity:.35; cursor:default; }
    .toggle .chev{ font-size:11px; line-height:1; transform:translateY(-.5px); }
    .taskName{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .isParent .taskName{ font-weight:700; letter-spacing:.1px; }

    /* Gantt */
    .ganttWrap{ position:relative; min-height:560px; }
    .ganttHeader{ position:sticky; top:0; z-index:4; background:rgba(10,18,32,.95); border-bottom:1px solid var(--line); }
    .ganttHeader .months{ display:flex; border-bottom:1px solid rgba(255,255,255,.08); }
    .ganttHeader .days{ display:flex; }
    .cell{ flex:0 0 auto; border-right:1px solid rgba(255,255,255,.06); padding:8px 6px; font-size:12px; color:var(--muted); text-align:center; user-select:none; }
    .cell.month{ font-weight:600; color:var(--text); background:rgba(255,255,255,.03); }
    .ganttBody{ position:relative; }
    .ganttRow{ position:relative; height:35px; border-bottom:1px solid rgba(255,255,255,.06); }
    .ganttRow:hover{ background:rgba(90,167,255,.08); }
    .vline{ position:absolute; top:0; bottom:0; width:1px; background:rgba(255,255,255,.06); }
    .bar{ position:absolute; top:9px; height:17px; border-radius:999px; background:rgba(90,167,255,.35); border:1px solid rgba(90,167,255,.45); overflow:hidden; box-shadow:0 4px 14px rgba(0,0,0,.25); }
    .bar .done{ height:100%; width:0%; background:rgba(24,195,126,.55); }
    .bar.late{ border-color:rgba(255,93,93,.55); background:rgba(255,93,93,.22); }
    .milestone{ position:absolute; top:7px; width:20px; height:20px; transform:rotate(45deg); background:rgba(90,167,255,.38); border:1px solid rgba(90,167,255,.55); border-radius:4px; box-shadow:0 4px 14px rgba(0,0,0,.25); }

    .footer{ margin-top:10px; color:var(--muted); font-size:12px; display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .link{ color:#a9c8ff; text-decoration:none; border-bottom:1px dotted rgba(169,200,255,.55); }
    .link:hover{ border-bottom-style:solid; }

    @media (max-width:1100px){
      .grid{ grid-template-columns:1fr; }
      .left{ border-right:none; border-bottom:1px solid var(--line); }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">
      <h1>Projeto São Mateus – Cronograma</h1>
      <small>Visão tipo MS Project | Expandir/Recolher por EDT (coluna B)</small>
    </div>

    <div class="controls">
      <input id="search" class="input" style="width:240px" placeholder="Buscar atividade, status, recurso..." />
      <select id="filterStatus" class="select">
        <option value="">Todos os status</option>
        <option value="Concluída">Concluída</option>
        <option value="Atrasada">Atrasada</option>
        <option value="Em andamento">Em andamento</option>
        <option value="Não iniciada">Não iniciada</option>
      </select>
      <select id="zoom" class="select">
        <option value="day">Zoom: Dia</option>
        <option value="week">Zoom: Semana</option>
      </select>
      <button id="expandAll" class="btn">Expandir tudo</button>
      <button id="collapseAll" class="btn">Recolher tudo</button>
      <button id="reload" class="btn primary">Recarregar</button>
      <span class="pill"><span class="dot"></span><span id="kpi">Carregando...</span></span>
    </div>
  </div>

  <div id="banner" class="banner"></div>

  <div class="panel">
    <div class="grid">
      <div class="left">
        <table>
          <thead>
            <tr>
              <th class="edt">EDT</th>
              <th>Atividade</th>
              <th class="status">Status</th>
              <th class="pct">% Concluída</th>
              <th class="date">Início</th>
              <th class="date">Término</th>
              <th>Recursos</th>
            </tr>
          </thead>
          <tbody id="gridBody"></tbody>
        </table>
      </div>

      <div class="right">
        <div class="ganttWrap">
          <div id="ganttHeader" class="ganttHeader"></div>
          <div id="ganttBody" class="ganttBody"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>
      Pasta do projeto:
      <a id="folderLink" class="link" target="_blank" rel="noopener">Abrir no Drive</a>
      &nbsp;|&nbsp; Fonte de dados:
      <a id="dataLink" class="link" target="_blank" rel="noopener">Abrir CSV</a>
    </div>
    <div id="meta"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const DRIVE_FOLDER_URL = "https://drive.google.com/drive/folders/1djCug4BgGpqOjbGmsqFQIwO8BN6w-ZGG";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vThtKDovGj-ADJfpxmf-wzGnIV9EunqDjx065wpvXgcSDaHgUhbNnVft72hIE9O0x64_LBx8u13Q9IU/pub?output=csv";
const EDT_FALLBACK_COL_INDEX = 1; // coluna B (0-based)

/* ================= UI ================= */
function showBanner(html){ const el=document.getElementById("banner"); el.style.display="block"; el.innerHTML=html; }
function hideBanner(){ const el=document.getElementById("banner"); el.style.display="none"; el.innerHTML=""; }

/* ================= Parsing helpers ================= */
function parseDateBR(s){
  if(s instanceof Date && !isNaN(s)) return s;
  if(typeof s === "number"){
    const d = new Date(Date.UTC(1899,11,30));
    d.setUTCDate(d.getUTCDate() + Math.floor(s));
    return new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
  }
  if(typeof s !== "string") return null;
  const t = s.trim();
  if(!t) return null;
  const cleaned = t.replace(/^(Seg|Ter|Qua|Qui|Sex|Sáb|Sab|Dom)\s+/i, "");
  let m = cleaned.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/);
  if(m){
    let dd=parseInt(m[1],10), mm=parseInt(m[2],10)-1, yy=parseInt(m[3],10);
    if(yy<100) yy+=2000;
    const d = new Date(yy,mm,dd);
    return isNaN(d)?null:d;
  }
  m = cleaned.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m){
    const d=new Date(parseInt(m[1],10),parseInt(m[2],10)-1,parseInt(m[3],10));
    return isNaN(d)?null:d;
  }
  const d = new Date(cleaned);
  return isNaN(d)?null:d;
}
function fmtDate(d){
  if(!d) return "";
  const dd=String(d.getDate()).padStart(2,"0");
  const mm=String(d.getMonth()+1).padStart(2,"0");
  const yy=String(d.getFullYear()).slice(-2);
  return `${dd}/${mm}/${yy}`;
}
function normPct(v){
  if(v==null) return 0;
  if(typeof v === "number") return (v<=1 ? v*100 : v);
  const s=String(v).trim().replace(",",".");
  const m=s.match(/([\d.]+)/);
  if(!m) return 0;
  const n=parseFloat(m[1]);
  return (s.includes("%") ? n : (n<=1 ? n*100 : n));
}
function statusClass(s){
  const t=(s||"").toLowerCase();
  if(t.includes("conclu")) return "good";
  if(t.includes("atras")) return "bad";
  if(t.includes("andam")) return "warn";
  if(t.includes("não")||t.includes("nao")) return "warn";
  return "warn";
}
function inferStatus(row){
  const pct=row.pct;
  const now=new Date();
  if(pct>=99.5) return "Concluída";
  if(row.finish && row.finish<now && pct<99.5) return "Atrasada";
  if(row.start && row.start<=now && pct>0 && pct<99.5) return "Em andamento";
  return "Não iniciada";
}
function normalizeHeader(h){
  return String(h||"")
    .trim()
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/\s+/g," ");
}
function indexOfHeader(headers, aliases){
  const norm = headers.map(normalizeHeader);
  for(const a of aliases){
    const idx = norm.indexOf(normalizeHeader(a));
    if(idx>=0) return idx;
  }
  return -1;
}

/* ================= Column mapping (EDT prioritário; fallback coluna B) ================= */
const ALIASES = {
  edt: ["edt","eap","wbs","outline","estrutura","estrutura analitica","estrutura analítica"],
  activity: ["atividade","nome","tarefa","task"],
  start: ["inicio","início","start","data inicio","data início"],
  finish: ["termino","término","finish","data termino","data término"],
  pct: ["% concluida","% concluída","%concluida","%concluída","percent","percentual","%"],
  status: ["status","situação","situacao"],
  resources: ["nomes dos recursos","recursos","resource names","responsavel","responsável"]
};

function mapColumns(headers){
  const idx = {
    edt: indexOfHeader(headers, ALIASES.edt),
    activity: indexOfHeader(headers, ALIASES.activity),
    start: indexOfHeader(headers, ALIASES.start),
    finish: indexOfHeader(headers, ALIASES.finish),
    pct: indexOfHeader(headers, ALIASES.pct),
    status: indexOfHeader(headers, ALIASES.status),
    resources: indexOfHeader(headers, ALIASES.resources)
  };

  // EDT obrigatório: se não achou pelo header, força coluna B
  if(idx.edt < 0) idx.edt = EDT_FALLBACK_COL_INDEX;

  if(idx.activity < 0 || idx.start < 0 || idx.finish < 0){
    throw new Error("Colunas mínimas não encontradas (Atividade, Início, Término). Verifique os cabeçalhos do CSV.");
  }
  return idx;
}

/* ================= EDT Tree helpers ================= */
function edtParts(edt){
  const s = String(edt||"").trim();
  if(!s) return [];
  return s.split(".").map(x=>x.trim()).filter(Boolean);
}
function edtLevel(edt){ return Math.max(1, edtParts(edt).length); }
function edtParent(edt){
  const p = edtParts(edt);
  if(p.length<=1) return null;
  return p.slice(0,p.length-1).join(".");
}
function edtSortKey(edt){
  const parts = edtParts(edt);
  return parts.map(x=>{
    const n = parseInt(x,10);
    return Number.isFinite(n) ? String(n).padStart(6,"0") : ("zzzzzz"+x);
  }).join(".");
}

function buildTree(tasks){
  const byEdt = new Map();
  tasks.forEach(t=>{
    t._edt = String(t.edt||"").trim();
    t.level = edtLevel(t._edt);
    t.parentEdt = edtParent(t._edt);
    t.children = [];
    t.hasChildren = false;
    t.isCollapsed = false;
    byEdt.set(t._edt, t);
  });

  tasks.forEach(t=>{
    if(t.parentEdt && byEdt.has(t.parentEdt)){
      const p = byEdt.get(t.parentEdt);
      p.children.push(t._edt);
      p.hasChildren = true;
    } else {
      t.parentEdt = null;
    }
  });

  tasks.forEach(t=>{
    if(t.hasChildren){
      t.children.sort((a,b)=> edtSortKey(a).localeCompare(edtSortKey(b)));
    }
  });

  const roots = tasks.filter(t=>!t.parentEdt).map(t=>t._edt);
  roots.sort((a,b)=> edtSortKey(a).localeCompare(edtSortKey(b)));

  return { byEdt, roots };
}

function computeVisible(tree){
  const visible=[];
  const {byEdt, roots}=tree;

  function dfs(edt){
    const node=byEdt.get(edt);
    if(!node) return;
    visible.push(node);
    if(node.hasChildren && node.isCollapsed) return;
    if(node.hasChildren){
      for(const c of node.children) dfs(c);
    }
  }
  for(const r of roots) dfs(r);
  return visible;
}

/* ================= STATE ================= */
let STATE = {
  allTasks: [],
  tree: null,
  visibleTasks: [],
  filteredTasks: [],
  zoom: "day"
};

function applyFilters(){
  const q=document.getElementById("search").value.trim().toLowerCase();
  const fs=document.getElementById("filterStatus").value;
  STATE.filteredTasks = STATE.visibleTasks.filter(t=>{
    const hay=`${t.edt} ${t.activity} ${t.status} ${t.resources}`.toLowerCase();
    return (!q || hay.includes(q)) && (!fs || t.status===fs);
  });
}
function refreshView(){
  if(!STATE.tree) return;
  STATE.visibleTasks = computeVisible(STATE.tree);
  applyFilters();
  renderGrid();
  renderGantt();
}

/* ================= GRID ================= */
function renderGrid(){
  const tb=document.getElementById("gridBody");
  tb.innerHTML="";

  for(const t of STATE.filteredTasks){
    const tr=document.createElement("tr");

    const tdE=document.createElement("td");
    tdE.className="edt";
    tdE.textContent = t.edt;

    const tdA=document.createElement("td");
    tdA.className="activity";
    tdA.title=t.activity;

    const cell=document.createElement("div");
    cell.className="treeCell" + (t.hasChildren ? " isParent" : "");

    const indent=document.createElement("span");
    indent.className="indent";
    indent.style.width=(Math.max(0,t.level-1)*14)+"px";

    const toggle=document.createElement("span");
    toggle.className="toggle";
    const enabled=!!t.hasChildren;
    toggle.setAttribute("aria-disabled", enabled ? "false" : "true");

    const chev=document.createElement("span");
    chev.className="chev";
    chev.textContent = enabled ? (t.isCollapsed ? "▶" : "▼") : "•";
    toggle.appendChild(chev);

    if(enabled){
      toggle.addEventListener("click",(ev)=>{
        ev.stopPropagation();
        t.isCollapsed=!t.isCollapsed;
        refreshView();
      });
    }

    const name=document.createElement("span");
    name.className="taskName";
    name.textContent=t.activity;

    cell.append(indent, toggle, name);
    tdA.appendChild(cell);

    const tdS=document.createElement("td");
    tdS.className="status";
    const cls=statusClass(t.status);
    tdS.innerHTML=`<span class="badge ${cls}"><span class="bDot"></span><span>${t.status}</span></span>`;

    const tdP=document.createElement("td");
    tdP.className="pct";
    tdP.textContent=`${Math.round(t.pct)}%`;

    const tdI=document.createElement("td");
    tdI.className="date";
    tdI.textContent=fmtDate(t.start);

    const tdF=document.createElement("td");
    tdF.className="date";
    tdF.textContent=fmtDate(t.finish);

    const tdR=document.createElement("td");
    tdR.className="res";
    tdR.title=t.resources||"";
    tdR.textContent=t.resources||"-";

    tr.append(tdE,tdA,tdS,tdP,tdI,tdF,tdR);
    tr.style.cursor="pointer";
    tr.addEventListener("click",()=>window.open(DRIVE_FOLDER_URL,"_blank","noopener"));

    tb.appendChild(tr);
  }
}

/* ================= GANTT ================= */
function getMinMaxDates(tasks){
  let min=tasks[0].start, max=tasks[0].finish;
  for(const t of tasks){ if(t.start<min) min=t.start; if(t.finish>max) max=t.finish; }
  const min2=new Date(min); min2.setDate(min2.getDate()-3);
  const max2=new Date(max); max2.setDate(max2.getDate()+3);
  return {min:min2, max:max2};
}
function daysBetween(a,b){
  const MS=24*3600*1000;
  const da=new Date(a.getFullYear(),a.getMonth(),a.getDate());
  const db=new Date(b.getFullYear(),b.getMonth(),b.getDate());
  return Math.round((db-da)/MS);
}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function monthLabel(d){
  const m=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"][d.getMonth()];
  return `${m}/${String(d.getFullYear()).slice(-2)}`;
}

function renderGantt(){
  const header=document.getElementById("ganttHeader");
  const body=document.getElementById("ganttBody");
  header.innerHTML=""; body.innerHTML="";

  const tasks=STATE.filteredTasks;
  if(tasks.length===0){
    header.innerHTML=`<div class="cell" style="padding:14px 10px">Sem itens para exibir (ajuste filtros/expansão).</div>`;
    return;
  }

  const {min,max}=getMinMaxDates(tasks);
  const zoom=STATE.zoom;
  const unitDays=(zoom==="day")?1:7;
  const totalUnits=Math.ceil((daysBetween(min,max)+1)/unitDays);
  const unitW=(zoom==="day")?26:52;
  const totalW=totalUnits*unitW;

  const monthsRow=document.createElement("div");
  monthsRow.className="months"; monthsRow.style.width=totalW+"px";
  const daysRow=document.createElement("div");
  daysRow.className="days"; daysRow.style.width=totalW+"px";

  if(zoom==="day"){
    let currentMonth=addDays(min,0).getMonth(), span=0, startIndex=0;
    for(let u=0;u<totalUnits;u++){
      const d=addDays(min,u);
      const c=document.createElement("div");
      c.className="cell"; c.style.width=unitW+"px";
      c.textContent=String(d.getDate()).padStart(2,"0");
      daysRow.appendChild(c);
      if(d.getMonth()===currentMonth){ span++; }
      else{
        const mcell=document.createElement("div");
        mcell.className="cell month";
        mcell.style.width=(span*unitW)+"px";
        mcell.textContent=monthLabel(addDays(min,startIndex));
        monthsRow.appendChild(mcell);
        currentMonth=d.getMonth(); span=1; startIndex=u;
      }
    }
    const mcell=document.createElement("div");
    mcell.className="cell month";
    mcell.style.width=(span*unitW)+"px";
    mcell.textContent=monthLabel(addDays(min,startIndex));
    monthsRow.appendChild(mcell);
  } else {
    let currentMonth=addDays(min,0).getMonth(), span=0, startIndex=0;
    for(let u=0;u<totalUnits;u++){
      const weekStart=addDays(min,u*7);
      const c=document.createElement("div");
      c.className="cell"; c.style.width=unitW+"px";
      c.textContent=`S${u+1}`;
      daysRow.appendChild(c);
      const m=weekStart.getMonth();
      if(m===currentMonth){ span++; }
      else{
        const mcell=document.createElement("div");
        mcell.className="cell month";
        mcell.style.width=(span*unitW)+"px";
        mcell.textContent=monthLabel(addDays(min,startIndex*7));
        monthsRow.appendChild(mcell);
        currentMonth=m; span=1; startIndex=u;
      }
    }
    const mcell=document.createElement("div");
    mcell.className="cell month";
    mcell.style.width=(span*unitW)+"px";
    mcell.textContent=monthLabel(addDays(min,startIndex*7));
    monthsRow.appendChild(mcell);
  }

  header.append(monthsRow, daysRow);

  const bodyWrap=document.createElement("div");
  bodyWrap.style.width=totalW+"px";
  bodyWrap.style.position="relative";

  for(let u=0;u<=totalUnits;u++){
    const vl=document.createElement("div");
    vl.className="vline"; vl.style.left=(u*unitW)+"px";
    bodyWrap.appendChild(vl);
  }

  tasks.forEach((t)=>{
    const row=document.createElement("div");
    row.className="ganttRow"; row.style.width=totalW+"px";

    const startOffDays=daysBetween(min,t.start);
    const finishOffDays=daysBetween(min,t.finish);

    let x1=(zoom==="day")?startOffDays:Math.floor(startOffDays/7);
    let x2=(zoom==="day")?finishOffDays:Math.floor(finishOffDays/7);

    const wUnits=Math.max(1,(x2-x1+1));
    const left=x1*unitW;
    const width=wUnits*unitW;

    const isMilestone=daysBetween(t.start,t.finish)===0;

    if(isMilestone){
      const ms=document.createElement("div");
      ms.className="milestone";
      ms.style.left=(left+Math.max(0,(unitW-20)/2))+"px";
      row.appendChild(ms);
    } else {
      const bar=document.createElement("div");
      bar.className="bar";
      if((t.status||"").toLowerCase().includes("atras")) bar.classList.add("late");
      bar.style.left=left+"px";
      bar.style.width=width+"px";

      const done=document.createElement("div");
      done.className="done";
      done.style.width=`${Math.max(0,Math.min(100,t.pct))}%`;

      bar.appendChild(done);
      row.appendChild(bar);
    }

    row.title=`${t.activity}\nEDT: ${t.edt}\nStatus: ${t.status}\n%: ${Math.round(t.pct)}%\nInício: ${fmtDate(t.start)}\nTérmino: ${fmtDate(t.finish)}\nRecursos: ${t.resources||"-"}`;
    row.style.cursor="pointer";
    row.addEventListener("click",()=>window.open(DRIVE_FOLDER_URL,"_blank","noopener"));
    bodyWrap.appendChild(row);
  });

  body.appendChild(bodyWrap);

  const totalAll = STATE.allTasks.length;
  const totalVisible = STATE.visibleTasks.length;
  const totalFiltered = STATE.filteredTasks.length;
  const concl = STATE.allTasks.filter(t=>(t.status||"").toLowerCase().includes("conclu")).length;
  const atras = STATE.allTasks.filter(t=>(t.status||"").toLowerCase().includes("atras")).length;

  document.getElementById("kpi").textContent =
    `Itens: ${totalFiltered}/${totalVisible} (visíveis) | Total: ${totalAll} | Concluídas: ${concl} | Atrasadas: ${atras}`;

  document.getElementById("meta").textContent =
    `Período: ${fmtDate(min)} → ${fmtDate(max)} | Zoom: ${zoom==="day"?"Dia":"Semana"}`;
}

/* ================= Expand / Collapse all ================= */
function expandAll(){
  if(!STATE.tree) return;
  for(const t of STATE.allTasks){ if(t.hasChildren) t.isCollapsed=false; }
  refreshView();
}
function collapseAll(){
  if(!STATE.tree) return;
  for(const t of STATE.allTasks){ if(t.hasChildren) t.isCollapsed=true; }
  refreshView();
}

/* ================= Load CSV ================= */
async function load(){
  hideBanner();
  document.getElementById("kpi").textContent="Carregando...";

  document.getElementById("folderLink").href = DRIVE_FOLDER_URL;
  document.getElementById("dataLink").href = CSV_URL;

  try{
    const res = await fetch(CSV_URL, { cache:"no-store" });
    const text = await res.text();
    if(!res.ok) throw new Error(`HTTP ${res.status}`);

    const parsed = Papa.parse(text, { skipEmptyLines:true });
    if(!parsed.data || parsed.data.length < 2) throw new Error("CSV sem dados.");

    const headers = parsed.data[0];
    const idx = mapColumns(headers);

    const tasks = [];
    for(let i=1;i<parsed.data.length;i++){
      const r = parsed.data[i];

      const edt = String(r[idx.edt] ?? "").trim();
      if(!edt) continue;

      const activity = String(r[idx.activity] || "").trim();
      if(!activity) continue;

      const start = parseDateBR(String(r[idx.start] ?? ""));
      const finish = parseDateBR(String(r[idx.finish] ?? ""));
      if(!start || !finish) continue;

      const pct = (idx.pct >= 0) ? normPct(r[idx.pct]) : 0;
      const status = (idx.status >= 0) ? String(r[idx.status] || "").trim() : "";
      const resources = (idx.resources >= 0) ? String(r[idx.resources] || "").trim() : "";

      const t = { edt, activity, start, finish, pct: isFinite(pct) ? Math.max(0, Math.min(100, pct)) : 0, status: status || "", resources };

      if(!t.status) t.status = inferStatus(t);
      if(t.finish < t.start){ const tmp=t.start; t.start=t.finish; t.finish=tmp; }

      tasks.push(t);
    }

    if(tasks.length === 0) throw new Error("Nenhuma linha válida (datas/cabeçalho).");

    tasks.sort((a,b)=> edtSortKey(a.edt).localeCompare(edtSortKey(b.edt)));

    STATE.allTasks = tasks;
    STATE.zoom = document.getElementById("zoom").value;

    STATE.tree = buildTree(STATE.allTasks);

    // Padrão: tudo expandido. Se quiser abrir “executivo” (só nível 1), descomente:
    // collapseAll(); return;

    refreshView();

    showBanner(`<strong>Fonte OK:</strong> CSV carregado. Linhas válidas: <b>${tasks.length}</b>.`);

  } catch(e){
    document.getElementById("kpi").textContent="Falha na leitura.";
    showBanner(`<strong>Falha ao carregar dados.</strong><br>Motivo: ${String(e.message || e)}`);
  }
}

/* ================= Events ================= */
document.getElementById("reload").addEventListener("click", load);
document.getElementById("search").addEventListener("input", refreshView);
document.getElementById("filterStatus").addEventListener("change", refreshView);
document.getElementById("zoom").addEventListener("change", () => { STATE.zoom=document.getElementById("zoom").value; renderGantt(); });
document.getElementById("expandAll").addEventListener("click", expandAll);
document.getElementById("collapseAll").addEventListener("click", collapseAll);

load();
</script>
</body>
</html>
